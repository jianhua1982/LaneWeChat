<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <title>Pay Demo</title>
    <style>
        *{
            margin: 30px;
            padding: 30px;
            -webkit-box-sizing:border-box;
        }

    </style>
</head>

<body>

<section>

    <p> 请选择付款类型 </p>

    <select>
        <option value="01">支付宝</option>
        <option value="02">微信支付</option>
        <option value="03">银联钱包</option>
        <option value="04">百度钱包</option>
    </select>

</section>


<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script src="../js/zepto.min.js"></script>

<script>

    var PHP_ROOT = 'http://www.wygreen.cn/LaneWeChat/';

    /**
     * 向php后台发送请求
     * @param path
     * @param data
     * @param success
     * @param fail
     */
    function ajaxPhp(path, data, success, fail) {
        "use strict";
        $.ajax({
            type: "GET",
            url: PHP_ROOT + path,
            dataType: "json",
            data: data,
            success: function (resp) {
                if (success) {
                    if(typeof resp === 'string') {
                        resp = JSON.parse(resp);
                    }
                    success(resp);
                }
            },
            error: function (err) {
                if (fail) {
                    fail(err);
                }
                else {
                    // fail
                    var msg = 'err = ' + JSON.stringify(err);
                    console.log(msg);
                }
            }
        });
    }

    var BACKEND_ROOT = 'http://www.wygreen.cn/LaneWeChat/';

    /**
     * 向php后台发送请求
     * @param path
     * @param data
     * @param success
     * @param fail
     */
    function ajax(path, data, success, fail) {
        "use strict";
        $.ajax({
            type: "GET",
            url: BACKEND_ROOT + path,
            dataType: "json",
            data: data,
            success: function (resp) {
                if (success) {
                    success(resp);
                }
            },
            error: function (err) {
                if (fail) {
                    fail(err);
                }
                else {
                    // fail
                    var msg = 'err = ' + JSON.stringify(err);
                    console.log(msg);
                    alert(msg);
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function(){

        //alert('Got DOMContentLoaded');
        console.log('Got DOMContentLoaded');

//        var phpBase = 'http://www.wygreen.cn/LaneWeChat/';
//
//
//        $.getJSON( phpBase + 'createSig.php', function (data, status){
//            //alert('data = ' + JSON.stringify(data));
//
//            if(status == 'success') {
//                // success
//                var msg = 'data = ' + JSON.stringify(data);
//                console.log(msg);
//                //alert(msg);
//
//                process(data, wx);
//            }
//            else {
//                // fail
//                var msg = 'data = ' + JSON.stringify(data);
//                console.log(msg);
//                //alert(msg);
//            }
//        });


        var openIdKey = 'www.qianduoduo.com.openid';
        var openid = localStorage.getItem(openIdKey);
        if(openid && openid.length) {
            // found cached one.
            userLoginProcess(openid);
        }
        else {
            // do auth process
            ajaxPhp('Server/getOpenId.php', null, function(data){
                // success
                openid = data.openid;
                localStorage.setItem(openIdKey, openid);
                userLoginProcess(openid);
            });
        }

        function userLoginProcess(openid) {
            /**
             *  openid --> backend, backend then tell the client whether new user or not (need to register?).
             */

            ajax('user.login', {openid: openid}, function(data){
                // success
                if(data.resp === '00') {
                    //
                }

                if(true) {
                    // need login, using phone + sms code to verify.
                }
            });
        }

        return;

        ajaxPhp('Server/createSig.php', null, function(data){
            // success
            var msg = 'data = ' + JSON.stringify(data);
            console.log(msg);
            //alert(msg);
            //process(data);

            var configParams = data;
            $.extend(configParams, {
                debug: true,
                jsApiList: [
                    'onMenuShareTimeline',
                    'onMenuShareAppMessage',
                    'scanQRCode'
                ]
            });

            wx.config(configParams);
        });


        function jsSdkProcess (wxData) {

            // wx is ready.
            wx.ready(function () {
                console.log('>> ready');
                //alert('>> ready');

                wx.scanQRCode({
                    needResult: 1, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
                    scanType: ["qrCode","barCode"], // 可以指定扫二维码还是一维码，默认二者都有
                    success: function (res) {
                        var result = res.resultStr; // 当needResult 为 1 时，扫码返回的结果
                    }
                });

                wx.scanQRCode(function(datga){

                }, function(err) {

                });
            });

            wx.error(function (res) {
                alert(res && res.errMsg);
            });
        }


    }, false);

</script>

</body>
</html>